<section class="admin-panel">
  <h2>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>

  <!-- –¢–ê–ë–´ -->
  <div class="tabs">
    <button
      [class.active]="activeTab === 'stats'"
      (click)="switchTab('stats')"
    >
      –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    </button>
    <button
      [class.active]="activeTab === 'users'"
      (click)="switchTab('users')"
    >
      –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
    </button>
    <button
      [class.active]="activeTab === 'reports'"
      (click)="switchTab('reports')"
    >
      –ñ–∞–ª–æ–±—ã
    </button>
  </div>

  @if (loading && !stats && !users.length && !reports.length) {
    <app-loading></app-loading>
  }

  <!-- –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
  @if (activeTab === 'stats' && stats) {
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value">{{ stats.totalUsers }}</div>
        <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ stats.totalPosts }}</div>
        <div class="stat-label">–í—Å–µ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–π</div>
      </div>
      <div class="stat-card warn">
        <div class="stat-value">{{ stats.pendingReports }}</div>
        <div class="stat-label">–ñ–∞–ª–æ–± –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ stats.totalReports }}</div>
        <div class="stat-label">–í—Å–µ–≥–æ –∂–∞–ª–æ–±</div>
      </div>
      <div class="stat-card danger">
        <div class="stat-value">{{ stats.blockedUsers }}</div>
        <div class="stat-label">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</div>
      </div>
    </div>
  }

  <!-- –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò -->
  @if (activeTab === 'users') {
    <div class="section-header">
      <input
        type="text"
        placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –∏–ª–∏ –∏–º–µ–Ω–∏..."
        [(ngModel)]="usersSearch"
        (keyup.enter)="searchUsers()"
      />
      <button (click)="searchUsers()">–ù–∞–π—Ç–∏</button>
    </div>

    <div class="users-table">
      <table>
        <thead>
          <tr>
            <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
            <th>–ò–º—è</th>
            <th>–†–æ–ª—å</th>
            <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody>
          @for (user of users; track user.id) {
            <tr [class.blocked]="user.isBlocked">
              <td>{{ user.phone }}</td>
              <td>{{ user.name || '‚Äî' }}</td>
              <td>
                <span [class.badge]="user.role === 'admin'" class="role">
                  {{ user.role === 'admin' ? 'üîë –ê–¥–º–∏–Ω' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }}
                </span>
              </td>
              <td>{{ user.createdAt }}</td>
              <td>
                @if (user.isBlocked) {
                  <span class="status blocked">üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>
                } @else {
                  <span class="status active">‚úÖ –ê–∫—Ç–∏–≤–µ–Ω</span>
                }
              </td>
              <td class="actions">
                <button
                  class="btn-small"
                  (click)="openBlockModal(user)"
                >
                  {{ user.isBlocked ? 'üîì' : 'üîí' }}
                </button>
                <button
                  class="btn-small delete"
                  (click)="deleteUserConfirm(user)"
                >
                  üóëÔ∏è
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    @if (usersTotalPages > 1) {
      <div class="pagination">
        @for (page of userPages; track page) {
          <span
            [class.active]="page === usersPage"
            (click)="loadUsers(page)"
          >
            {{ page }}
          </span>
        }
      </div>
    }
  }

  <!-- –ñ–ê–õ–û–ë–´ -->
  @if (activeTab === 'reports') {
    <div class="section-header">
      <select [(ngModel)]="reportsStatusFilter" (change)="filterReports()">
        <option value="">–í—Å–µ –∂–∞–ª–æ–±—ã</option>
        <option value="pending">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</option>
        <option value="reviewed">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ</option>
        <option value="resolved">–†–µ—à–µ–Ω–æ</option>
        <option value="rejected">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</option>
      </select>
    </div>

    <div class="reports-list">
      @for (report of reports; track report.id) {
        <div class="report-card">
          <div class="report-header">
            <span class="report-status" [attr.data-status]="report.status">
              {{ report.status }}
            </span>
            <span class="report-date">{{ report.createdAt }}</span>
          </div>
          <div class="report-body">
            <p><strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> {{ report.reason }}</p>
            <p><strong>–û—Ç:</strong> {{ report.reporter.phone }} ({{ report.reporter.name || '–ë–µ–∑ –∏–º–µ–Ω–∏' }})</p>
            <p><strong>–ù–∞:</strong> {{ report.reportedUser.phone }} ({{ report.reportedUser.name || '–ë–µ–∑ –∏–º–µ–Ω–∏' }})</p>
            @if (report.description) {
              <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> {{ report.description }}</p>
            }
            @if (report.post) {
              <p><strong>–ü–æ—Å—Ç:</strong> {{ report.post.title }}</p>
            }
            @if (report.adminComment) {
              <p class="admin-comment"><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∞–¥–º–∏–Ω–∞:</strong> {{ report.adminComment }}</p>
            }
          </div>
          <div class="report-actions">
            <button (click)="openReportModal(report)">üìù –û–±—Ä–∞–±–æ—Ç–∞—Ç—å</button>
          </div>
        </div>
      }
    </div>

    @if (reportsTotalPages > 1) {
      <div class="pagination">
        @for (page of reportPages; track page) {
          <span
            [class.active]="page === reportsPage"
            (click)="loadReports(page)"
          >
            {{ page }}
          </span>
        }
      </div>
    }
  }
</section>

<!-- –ú–û–î–ê–õ–ö–ê –ë–õ–û–ö–ò–†–û–í–ö–ò -->
@if (selectedUser) {
  <div class="modal-overlay" (click)="selectedUser = null">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>{{ selectedUser.isBlocked ? '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' }} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
      <p>{{ selectedUser.phone }} ({{ selectedUser.name || '–ë–µ–∑ –∏–º–µ–Ω–∏' }})</p>
      <textarea
        placeholder="–ü—Ä–∏—á–∏–Ω–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
        [(ngModel)]="blockReason"
        rows="8"
      ></textarea>
      <div class="modal-actions">
        <button (click)="selectedUser = null" class="btn-cancel">–û—Ç–º–µ–Ω–∞</button>
        <button (click)="toggleBlock()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
      </div>
    </div>
  </div>
}

<!-- –ú–û–î–ê–õ–ö–ê –ñ–ê–õ–û–ë–´ -->
@if (selectedReport) {
  <div class="modal-overlay" (click)="selectedReport = null">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>–û–±—Ä–∞–±–æ—Ç–∫–∞ –∂–∞–ª–æ–±—ã</h3>
      <div class="form-row">
        <label>–°—Ç–∞—Ç—É—Å:</label>
        <select [(ngModel)]="reportStatus">
          <option value="pending">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</option>
          <option value="reviewed">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ</option>
          <option value="resolved">–†–µ—à–µ–Ω–æ</option>
          <option value="rejected">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</option>
        </select>
      </div>
      <div class="form-row">
        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
        <textarea [(ngModel)]="reportComment" rows="3"></textarea>
      </div>
      <div class="modal-actions">
        <button (click)="selectedReport = null" class="btn-cancel">–û—Ç–º–µ–Ω–∞</button>
        <button (click)="updateReportStatus()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
}