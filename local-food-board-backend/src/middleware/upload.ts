import multer from 'multer';
import path from 'path';
import fs from 'fs';
import { MAX_PHOTOS, MAX_FILE_SIZE } from '../utils/constants';

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–∞–ø–∫—É –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
const uploadDir = path.join(process.cwd(), 'uploads');

// –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
if (!fs.existsSync(uploadDir)) {
  fs.mkdirSync(uploadDir, { recursive: true });
  console.log(`üìÅ –°–æ–∑–¥–∞–Ω–∞ –ø–∞–ø–∫–∞: ${uploadDir}`);
}

/**
 * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–ª—è multer
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫—É–¥–∞ –∏ —Å –∫–∞–∫–∏–º –∏–º–µ–Ω–µ–º —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ñ–∞–π–ª—ã
 */
const storage = multer.diskStorage({
  /**
   * –§—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–∞–ø–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Ñ–∞–π–ª–∞
   * @param req - –û–±—ä–µ–∫—Ç –∑–∞–ø—Ä–æ—Å–∞ Express
   * @param file - –ó–∞–≥—Ä—É–∂–∞–µ–º—ã–π —Ñ–∞–π–ª
   * @param cb - Callback –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–æ—à–∏–±–∫–∞, –ø—É—Ç—å)
   */
  destination(req, file, cb) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫—É uploads
    cb(null, uploadDir);
  },

  /**
   * –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
   * –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏–º—ë–Ω –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å —Ñ–∞–π–ª–æ–≤
   * 
   * @param req - –û–±—ä–µ–∫—Ç –∑–∞–ø—Ä–æ—Å–∞ Express
   * @param file - –ó–∞–≥—Ä—É–∂–∞–µ–º—ã–π —Ñ–∞–π–ª —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º
   * @param cb - Callback –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–æ—à–∏–±–∫–∞, –∏–º—è —Ñ–∞–π–ª–∞)
   */
  filename(req, file, cb) {
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è: timestamp + —Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ
    // –ù–∞–ø—Ä–∏–º–µ—Ä: 1734188400000-384729123.jpg
    const unique = Date.now() + '-' + Math.round(Math.random() * 1e9);
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ (.jpg, .png –∏ —Ç.–¥.)
    const filename = unique + path.extname(file.originalname);
    
    cb(null, filename);
  }
});

/**
 * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ multer middleware
 * –í–∫–ª—é—á–∞–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ç–∏–ø–∞ –∏ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–æ–≤
 */
const upload = multer({
  storage,                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
  limits: { 
    fileSize: MAX_FILE_SIZE       // –ú–∞–∫—Å–∏–º—É–º 5MB –Ω–∞ —Ñ–∞–π–ª
  },
  
  /**
   * –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤
   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
   * 
   * @param req - –û–±—ä–µ–∫—Ç –∑–∞–ø—Ä–æ—Å–∞ Express
   * @param file - –ó–∞–≥—Ä—É–∂–∞–µ–º—ã–π —Ñ–∞–π–ª
   * @param cb - Callback (–æ—à–∏–±–∫–∞ –∏–ª–∏ null, –ø—Ä–∏–Ω—è—Ç—å —Ñ–∞–π–ª true/false)
   */
  fileFilter(req, file, cb) {
    // –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
    const allowedExtensions = /jpeg|jpg|png|webp/;
    
    // –ü–æ–ª—É—á–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ
    const ext = path.extname(file.originalname).toLowerCase();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º MIME type –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    const allowedMimeTypes = /image\/(jpeg|jpg|png|webp)/;
    
    // –ï—Å–ª–∏ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ, –∏ MIME type –≤–∞–ª–∏–¥–Ω—ã - –ø—Ä–∏–Ω–∏–º–∞–µ–º —Ñ–∞–π–ª
    if (allowedExtensions.test(ext) && allowedMimeTypes.test(file.mimetype)) {
      cb(null, true);
    } else {
      // –ò–Ω–∞—á–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É
      cb(new Error('–¢–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (jpg, png, webp)'));
    }
  }
});

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π middleware
export default upload;